<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workout Tracker — نسخة ملف واحد</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM UMD -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- Babel to run JSX in one file (dev/demo) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-zinc-50 dark:bg-zinc-950 text-zinc-900 dark:text-zinc-50">
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // =============================
    // Utilities
    // =============================
    const clx = (...arr) => arr.filter(Boolean).join(" ");
    const safeParse = (v, d) => { try { const x = JSON.parse(v); return x ?? d; } catch { return d; } };
    const uid = () => Math.random().toString(36).slice(2, 10);
    const roundTo = (num, step) => Math.round(num / step) * step;
    const nowIso = () => new Date().toISOString();
    const estimate1RM = (weight, reps) => { const w = Number(weight)||0; const r = Number(reps)||0; if(!w||!r) return 0; return w*(1+r/30); };
    const suggestSets = ({ lastWeight, lastReps, targetReps = 10, stepKg = 2.5, percents = [0.7,0.725,0.75,0.775] }) => {
      const est = estimate1RM(lastWeight, lastReps); if(!est) return []; return percents.map(p=>({ weight: Math.max(stepKg, roundTo(est*p, stepKg)), reps: targetReps, rpe: 7.5 })); };

    // =============================
    // I18N strings
    // =============================
    const STR = {
      appTitle: { en: "Workout Tracker", ar: "متابعة التمرين" },
      workout: { en: "Workout", ar: "التمرين" },
      history: { en: "History", ar: "السجل" },
      profile: { en: "Profile", ar: "الملف الشخصي" },
      backup: { en: "Backup", ar: "نسخة احتياطية" },
      search: { en: "Search exercises...", ar: "ابحث عن تمرين..." },
      chooseMuscle: { en: "Muscle Groups", ar: "مجموعات العضلات" },
      add: { en: "Add", ar: "إضافة" },
      sets: { en: "Sets", ar: "المجموعات" },
      weight: { en: "Weight (kg)", ar: "الوزن (كجم)" },
      reps: { en: "Reps", ar: "عداد" },
      rpe: { en: "RPE", ar: "جهد" },
      plate: { en: "Plate #", ar: "رقم البليت" },
      type: { en: "Type", ar: "النوع" },
      free: { en: "Free Weights", ar: "حديد حر" },
      machine: { en: "Machine", ar: "جهاز" },
      cable: { en: "Cable", ar: "كيبل" },
      addSet: { en: "+ Add Set", ar: "+ مجموعة" },
      remove: { en: "Remove", ar: "حذف" },
      suggest: { en: "Auto-suggest", ar: "اقتراح تلقائي" },
      copyLast: { en: "Copy Last", ar: "نسخ آخر" },
      finishSave: { en: "Finish & Save", ar: "انهاء وحفظ" },
      noSessions: { en: "No sessions yet.", ar: "لا يوجد جلسات بعد." },
      session: { en: "Session", ar: "جلسة" },
      view: { en: "View", ar: "عرض" },
      useTemplate: { en: "Use as Template", ar: "استخدام كقالب" },
      delete: { en: "Delete", ar: "حذف" },
      bodyWeight: { en: "Body Weight (kg)", ar: "الوزن (كجم)" },
      height: { en: "Height (cm)", ar: "الطول (سم)" },
      experience: { en: "Experience", ar: "المستوى" },
      beginner: { en: "Beginner", ar: "مبتدئ" },
      intermediate: { en: "Intermediate", ar: "متوسط" },
      advanced: { en: "Advanced", ar: "متقدم" },
      saveProfile: { en: "Save Profile", ar: "حفظ الملف" },
      stackStep: { en: "Machine Stack Step (kg)", ar: "خطوة جهاز (كجم)" },
      barbellStep: { en: "Free Weight Step (kg)", ar: "خطوة الحديد الحر (كجم)" },
      targetReps: { en: "Target Reps", ar: "عداد مستهدف" },
      lastSet: { en: "Calibration Set", ar: "مجموعة معايرة" },
      lastWeight: { en: "Last Weight (kg)", ar: "آخر وزن (كجم)" },
      lastReps: { en: "Last Reps", ar: "آخر عداد" },
      apply: { en: "Apply", ar: "تطبيق" },
      cancel: { en: "Cancel", ar: "إلغاء" },
      exportJson: { en: "Export JSON", ar: "تصدير JSON" },
      importJson: { en: "Import JSON", ar: "استيراد JSON" },
      dataHere: { en: "Paste data here", ar: "الصق البيانات هنا" },
      restTimer: { en: "Rest Timer", ar: "مؤقت الراحة" },
      start: { en: "Start", ar: "بدء" },
      stop: { en: "Stop", ar: "إيقاف" },
      reset: { en: "Reset", ar: "إعادة" },
    };

    // =============================
    // Exercise Library
    // =============================
    const LIB = [
      { id: 'back', en: 'Back', ar: 'الظهر', exercises: [
        { id: 'lat_pulldown', en: 'Lat Pulldown', ar: 'سحب أمامي', type: 'cable' },
        { id: 'seated_row', en: 'Seated Cable Row', ar: 'سحب جالس', type: 'cable' },
        { id: 'barbell_row', en: 'Barbell Row', ar: 'تمرين الطلوع بالبار', type: 'free' },
        { id: 'dumbbell_row', en: 'One-Arm DB Row', ar: 'تجديف دمبل', type: 'free' },
        { id: 'tbar_row', en: 'T-Bar Row', ar: 'تجديف تي بار', type: 'machine' },
        { id: 'deadlift', en: 'Deadlift', ar: 'الرفعة الميتة', type: 'free' },
        { id: 'pullup', en: 'Pull-Up / Assisted', ar: 'عقلة / مساعد', type: 'machine' },
        { id: 'facepull', en: 'Face Pull', ar: 'سحب للوجه', type: 'cable' },
        { id: 'straight_pulldown', en: 'Straight-Arm Pulldown', ar: 'سحب مستقيم', type: 'cable' },
      ]},
      { id: 'chest', en: 'Chest', ar: 'الصدر', exercises: [
        { id: 'bench_press', en: 'Barbell Bench Press', ar: 'بنش بار', type: 'free' },
        { id: 'incline_db', en: 'Incline DB Press', ar: 'ضغط مائل دمبل', type: 'free' },
        { id: 'decline_press', en: 'Decline Press', ar: 'ضغط مائل للأسفل', type: 'machine' },
        { id: 'chest_press', en: 'Machine Chest Press', ar: 'جهاز صدر', type: 'machine' },
        { id: 'cable_fly', en: 'Cable Fly', ar: 'فلاي كيبل', type: 'cable' },
        { id: 'pec_deck', en: 'Pec Deck Fly', ar: 'فلاي بيك ديك', type: 'machine' },
        { id: 'pushup', en: 'Push-Up', ar: 'ضغط أرضي', type: 'free' },
        { id: 'smith_bench', en: 'Smith Bench Press', ar: 'بنش سميث', type: 'machine' },
      ]},
      { id: 'legs', en: 'Legs', ar: 'الأرجل', exercises: [
        { id: 'squat', en: 'Back Squat', ar: 'سكوات', type: 'free' },
        { id: 'front_squat', en: 'Front Squat', ar: 'سكوات أمامي', type: 'free' },
        { id: 'leg_press', en: 'Leg Press', ar: 'ضغط رجل', type: 'machine' },
        { id: 'rdl', en: 'Romanian Deadlift', ar: 'رفعة رومانية', type: 'free' },
        { id: 'leg_curl', en: 'Lying Leg Curl', ar: 'كورل هامسترنغ', type: 'machine' },
        { id: 'leg_extension', en: 'Leg Extension', ar: 'اكستنشن ربلة', type: 'machine' },
        { id: 'lunge', en: 'Walking Lunges', ar: 'لونجز مشي', type: 'free' },
        { id: 'hack_squat', en: 'Hack Squat', ar: 'هاك سكوات', type: 'machine' },
      ]},
      { id: 'shoulders', en: 'Shoulders', ar: 'الكتف', exercises: [
        { id: 'ohp', en: 'Overhead Press', ar: 'ضغط كتف', type: 'free' },
        { id: 'db_shoulder_press', en: 'DB Shoulder Press', ar: 'ضغط كتف دمبل', type: 'free' },
        { id: 'lateral_raise', en: 'Lateral Raise', ar: 'رفرفة جانبية', type: 'free' },
        { id: 'rear_delt_fly', en: 'Rear Delt Fly', ar: 'فلاي خلفي', type: 'free' },
        { id: 'smith_ohp', en: 'Smith Shoulder Press', ar: 'ضغط كتف سميث', type: 'machine' },
        { id: 'cable_lateral', en: 'Cable Lateral Raise', ar: 'رفرفة كيبل', type: 'cابلe' },
      ]},
      { id: 'biceps', en: 'Biceps', ar: 'باي', exercises: [
        { id: 'barbell_curl', en: 'Barbell Curl', ar: 'كرل بار', type: 'free' },
        { id: 'db_curl', en: 'DB Alternating Curl', ar: 'كرل دمبل', type: 'free' },
        { id: 'preacher_curl', en: 'Preacher Curl', ar: 'كرسي باي', type: 'machine' },
        { id: 'cable_curl', en: 'Cable Curl', ar: 'كرل كيبل', type: 'cable' },
        { id: 'hammer_curl', en: 'Hammer Curl', ar: 'كرل مطرقة', type: 'free' },
      ]},
      { id: 'triceps', en: 'Triceps', ar: 'تراي', exercises: [
        { id: 'pushdown', en: 'Triceps Pushdown', ar: 'دفع تراي', type: 'cable' },
        { id: 'skullcrusher', en: 'Skull Crusher', ar: 'سكل كراشر', type: 'free' },
        { id: 'overhead_ext', en: 'Overhead Extension', ar: 'تمديد فوق الرأس', type: 'cable' },
        { id: 'dip', en: 'Dips / Assisted', ar: 'ديبس / مساعد', type: 'machine' },
        { id: 'rope_pushdown', en: 'Rope Pushdown', ar: 'حبل تراي', type: 'cable' },
      ]},
      { id: 'forearms', en: 'Forearms', ar: 'سواعد', exercises: [
        { id: 'wrist_curl', en: 'Wrist Curl', ar: 'كرل معصم', type: 'free' },
        { id: 'rev_wrist_curl', en: 'Reverse Wrist Curl', ar: 'كرل معصم عكسي', type: 'free' },
        { id: 'farmer_walk', en: "Farmer's Walk", ar: 'مشية المزارع', type: 'free' },
      ]},
      { id: 'abs', en: 'Abs', ar: 'بطن', exercises: [
        { id: 'crunch', en: 'Crunch', ar: 'كرنش', type: 'free' },
        { id: 'hanging_raise', en: 'Hanging Leg Raise', ar: 'رفع أرجل معلق', type: 'free' },
        { id: 'cable_crunch', en: 'Cable Crunch', ar: 'كرنش كيبل', type: 'cable' },
        { id: 'plank', en: 'Plank', ar: 'بلانك', type: 'free' },
      ]},
      { id: 'calves', en: 'Calves', ar: 'ساق (سمانة)', exercises: [
        { id: 'standing_calf', en: 'Standing Calf Raise', ar: 'رفع سمانة واقف', type: 'machine' },
        { id: 'seated_calf', en: 'Seated Calf Raise', ar: 'رفع سمانة جالس', type: 'machine' },
        { id: 'donkey_calf', en: 'Donkey Calf Raise', ar: 'رفع سمانة حمار', type: 'machine' },
      ]},
    ];

    // =============================
    // LocalStorage keys
    // =============================
    const LS = { profile: 'wt_profile_v1', history: 'wt_history_v1', workout: 'wt_current_v1', settings: 'wt_settings_v1' };

    // =============================
    // Small widgets
    // =============================
    function Pill({ active, onClick, children }){
      return <button onClick={onClick} className={clx('px-3 py-1 rounded-full text-sm border', active? 'bg-indigo-600 text-white border-indigo-600':'bg-white/70 dark:bg-zinc-800 border-zinc-300 dark:border-zinc-700')}>{children}</button>
    }
    function Field({ label, children }){
      return (<label className="flex flex-col gap-1 text-sm"><span className="text-zinc-600 dark:text-zinc-300">{label}</span>{children}</label>);
    }
    function IconButton({ title, onClick, children }){
      return <button type="button" title={title} onClick={onClick} className="px-3 py-1 rounded-md text-sm border bg-white/70 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700 hover:bg-zinc-100 dark:hover:bg-zinc-800">{children}</button>
    }

    // =============================
    // Rest timer hook
    // =============================
    function useTimer(){
      const [sec, setSec] = useState(0); const [running, setRunning] = useState(false);
      useEffect(()=>{ if(!running) return; const id=setInterval(()=>setSec(s=>s+1),1000); return ()=>clearInterval(id); },[running]);
      const start=()=>setRunning(true), stop=()=>setRunning(false), reset=()=>setSec(0);
      const mm=String(Math.floor(sec/60)).padStart(2,'0'), ss=String(sec%60).padStart(2,'0');
      return { sec, running, start, stop, reset, label: `${mm}:${ss}` };
    }

    // =============================
    // Exercise Card
    // =============================
    function ExerciseCard({ it, idx, lang, str, settings, onChange, onRemove }){
      const timer = useTimer();
      const [showSuggest, setShowSuggest] = useState(false);
      const [cal, setCal] = useState({ lastWeight: '', lastReps: '10', targetReps: '10' });
      const step = it.type === 'free' ? settings.barStep : settings.stackStep;
      const setField = (si, key, val) => { const sets = it.sets.map((s,i)=> i===si? { ...s, [key]: val }: s); onChange({ sets }); };
      const addSet = () => onChange({ sets: [...it.sets, { weight:'', reps:'', rpe:'', plate:'' }] });
      const removeSet = (i) => onChange({ sets: it.sets.filter((_,x)=>x!==i) });
      const copyLast = () => { const s=it.sets.find(s=>s.weight && s.reps); if(!s) return; onChange({ sets: it.sets.map(()=>({ ...s })) }); };
      const applySuggest = () => { const arr = suggestSets({ lastWeight:Number(cal.lastWeight), lastReps:Number(cal.lastReps), targetReps:Number(cal.targetReps), stepKg: step }); if(arr.length){ const newSets = it.sets.map((_,i)=> arr[i] ?? { weight:'', reps:'', rpe:'' }); onChange({ sets: newSets }); setShowSuggest(false); } };
      const weightToPlate = (w) => { const kg=Number(w)||0; if(!kg||step<=0) return ''; return Math.round(kg/step); };
      useEffect(()=>{ const sets = it.sets.map(s=> ({ ...s, plate: it.type==='machine'? weightToPlate(s.weight): s.plate })); onChange({ sets }); }, [settings.stackStep, it.type]);

      return (
        <div className="rounded-xl border bg-white/80 dark:bg-zinc-900 border-zinc-200 dark:border-zinc-800 p-3">
          <div className="flex items-center justify-between gap-2">
            <div className="font-semibold">{it.name.en} <span className="opacity-70">/ {it.name.ar}</span><span className="ml-2 text-xs opacity-70">({str(it.type)})</span></div>
            <div className="flex gap-2">
              <IconButton onClick={copyLast}>{str('copyLast')}</IconButton>
              <IconButton onClick={()=>setShowSuggest(true)}>{str('suggest')}</IconButton>
              <IconButton onClick={onRemove}>{str('remove')}</IconButton>
            </div>
          </div>
          <div className="mt-3 overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left border-b border-zinc-200 dark:border-zinc-800">
                  <th className="py-1 pr-3">#</th>
                  <th className="py-1 pr-3">{str('weight')}</th>
                  <th className="py-1 pr-3">{str('reps')}</th>
                  <th className="py-1 pr-3">{str('rpe')}</th>
                  {it.type !== 'free' && <th className="py-1 pr-3">{str('plate')}</th>}
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {it.sets.map((s,i)=> (
                  <tr key={i} className="border-b border-zinc-100 dark:border-zinc-800">
                    <td className="py-1 pr-3">{i+1}</td>
                    <td className="py-1 pr-3"><input type="number" step={step} value={s.weight} onChange={e=>setField(i,'weight',e.target.value)} className="w-28 px-2 py-1 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" /></td>
                    <td className="py-1 pr-3"><input type="number" step="1" value={s.reps} onChange={e=>setField(i,'reps',e.target.value)} className="w-20 px-2 py-1 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" /></td>
                    <td className="py-1 pr-3"><input type="number" step="0.5" value={s.rpe} onChange={e=>setField(i,'rpe',e.target.value)} className="w-20 px-2 py-1 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" /></td>
                    {it.type !== 'free' && (
                      <td className="py-1 pr-3"><input type="number" step="1" value={s.plate} onChange={e=>setField(i,'plate',e.target.value)} className="w-20 px-2 py-1 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" /></td>
                    )}
                    <td className="py-1 pr-3 text-right"><IconButton onClick={()=>removeSet(i)}>-</IconButton></td>
                  </tr>
                ))}
              </tbody>
            </table>
            <div className="mt-2 flex items-center gap-2">
              <button onClick={addSet} className="px-3 py-1 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700">{str('addSet')}</button>
              <div className="ml-auto flex items-center gap-2 text-sm"><span className="opacity-70">{str('restTimer')}: {timer.label}</span>{!timer.running ? (<IconButton onClick={timer.start}>{str('start')}</IconButton>) : (<IconButton onClick={timer.stop}>{str('stop')}</IconButton>)}<IconButton onClick={timer.reset}>{str('reset')}</IconButton></div>
            </div>
          </div>
          {showSuggest && (
            <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 p-3" onClick={()=>setShowSuggest(false)}>
              <div className="w-full max-w-md rounded-2xl border bg-white dark:bg-zinc-900 border-zinc-200 dark:border-zinc-800 p-4" onClick={(e)=>e.stopPropagation()}>
                <div className="text-base font-semibold mb-2">{str('suggest')}</div>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <Field label={str('lastWeight')}><input type="number" step={step} value={cal.lastWeight} onChange={e=>setCal(c=>({...c,lastWeight:e.target.value}))} className="px-2 py-1 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700"/></Field>
                  <Field label={str('lastReps')}><input type="number" step="1" value={cal.lastReps} onChange={e=>setCal(c=>({...c,lastReps:e.target.value}))} className="px-2 py-1 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700"/></Field>
                  <Field label={str('targetReps')}><input type="number" step="1" value={cal.targetReps} onChange={e=>setCal(c=>({...c,targetReps:e.target.value}))} className="px-2 py-1 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700"/></Field>
                </div>
                <div className="mt-3 flex gap-2 justify-end">
                  <button onClick={()=>setShowSuggest(false)} className="px-3 py-2 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700">{str('cancel')}</button>
                  <button onClick={applySuggest} className="px-3 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white">{str('apply')}</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================
    // Main App
    // =============================
    function App(){
      const [lang, setLang] = useState('ar');
      const dir = lang==='ar'? 'rtl':'ltr';
      const [query, setQuery] = useState('');
      const [activeMuscle, setActiveMuscle] = useState(LIB[0].id);
      const [profile, setProfile] = useState(()=> safeParse(localStorage.getItem(LS.profile), { bodyWeight:'', height:'', exp:'beginner' }));
      useEffect(()=> localStorage.setItem(LS.profile, JSON.stringify(profile)), [profile]);
      const [settings, setSettings] = useState(()=> safeParse(localStorage.getItem(LS.settings), { stackStep:5, barStep:2.5, theme:'dark' }));
      useEffect(()=> localStorage.setItem(LS.settings, JSON.stringify(settings)), [settings]);
      useEffect(()=> { document.documentElement.classList.toggle('dark', settings.theme==='dark'); },[settings.theme]);
      const [current, setCurrent] = useState(()=> safeParse(localStorage.getItem(LS.workout), { id: uid(), startedAt: nowIso(), items: [], note:'' }));
      useEffect(()=> localStorage.setItem(LS.workout, JSON.stringify(current)), [current]);
      const [history, setHistory] = useState(()=> safeParse(localStorage.getItem(LS.history), []));
      useEffect(()=> localStorage.setItem(LS.history, JSON.stringify(history)), [history]);

      const muscle = useMemo(()=> LIB.find(m=>m.id===activeMuscle), [activeMuscle]);
      const filtered = useMemo(()=> { const q=query.trim().toLowerCase(); if(!q) return muscle.exercises; return muscle.exercises.filter(e=> [e.en,e.ar].some(t=> t.toLowerCase().includes(q))); }, [query, muscle]);
      const str = (k)=> STR[k]?.[lang] ?? k;
      const addExercise = (ex)=> setCurrent(c=> ({ ...c, items: [...c.items, { id: uid(), exerciseId: ex.id, muscleId: muscle.id, type: ex.type, name:{ en: ex.en, ar: ex.ar }, sets:[{weight:'',reps:'',rpe:'',plate:''},{weight:'',reps:'',rpe:'',plate:''},{weight:'',reps:'',rpe:'',plate:''},{weight:'',reps:'',rpe:'',plate:''}], notes:'' }] }));
      const updateItem = (id, patch)=> setCurrent(c=> ({ ...c, items: c.items.map(it=> it.id===id? { ...it, ...patch }: it) }));
      const removeItem = (id)=> setCurrent(c=> ({ ...c, items: c.items.filter(it=> it.id!==id) }));
      const totalVolume = useMemo(()=> current.items.reduce((sum,it)=> sum + it.sets.reduce((s,st)=> s + (Number(st.weight)||0)*(Number(st.reps)||0),0), 0), [current]);
      const finishAndSave = ()=> { const session = { id: current.id, startedAt: current.startedAt, endedAt: nowIso(), items: current.items, note: current.note, profile, settings, volume: totalVolume }; setHistory(h=> [session, ...h]); setCurrent({ id: uid(), startedAt: nowIso(), items: [], note:'' }); alert(lang==='ar'? 'تم حفظ الجلسة':'Session saved'); };
      const useAsTemplate = (session)=> setCurrent({ id: uid(), startedAt: nowIso(), items: session.items.map(it=> ({ ...it, id: uid(), sets: it.sets.map(()=> ({ weight:'', reps:'', rpe:'', plate:'' })) })), note:'' });
      const deleteSession = (id)=> setHistory(h=> h.filter(s=> s.id!==id));

      const [importText, setImportText] = useState('');
      const doExport = ()=> { const data={ profile, settings, history }; const blob=new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`workout_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); };
      const doImport = ()=> { try { const data=JSON.parse(importText); if(data.profile) setProfile(data.profile); if(data.settings) setSettings(data.settings); if(Array.isArray(data.history)) setHistory(data.history); alert(lang==='ar'? 'تم الاستيراد':'Imported'); } catch { alert(lang==='ar'? 'صيغة غير صحيحة':'Invalid JSON'); } };

      const [tab, setTab] = useState('workout');

      return (
        <div dir={dir} className="min-h-screen">
          <div className="mx-auto max-w-4xl px-3 pb-24">
            <header className="sticky top-0 z-20 backdrop-blur bg-zinc-50/70 dark:bg-zinc-950/70 border-b border-zinc-200 dark:border-zinc-800">
              <div className="max-w-4xl mx-auto px-3 py-3 flex items-center justify-between gap-3">
                <h1 className="text-xl font-bold tracking-tight">{str('appTitle')} <span className="opacity-70">/ {lang==='ar'? 'AR':'EN'}</span></h1>
                <div className="flex items-center gap-2">
                  <select className="px-2 py-1 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" value={lang} onChange={e=>setLang(e.target.value)}>
                    <option value="ar">العربية</option>
                    <option value="en">English</option>
                  </select>
                  <button onClick={()=> setSettings(s=> ({...s, theme: s.theme==='dark'? 'light':'dark'}))} className="px-2 py-1 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" title={settings.theme==='dark'? 'Light':'Dark'}>
                    {settings.theme==='dark'? (lang==='ar'? 'نهاري':'Light') : (lang==='ar'? 'ليلي':'Dark')}
                  </button>
                </div>
              </div>
              <nav className="max-w-4xl mx-auto px-3 pb-2 flex gap-2 text-sm">
                {[{id:'workout',t:str('workout')},{id:'history',t:str('history')},{id:'profile',t:str('profile')},{id:'backup',t:str('backup')}].map(t=> (
                  <Pill key={t.id} active={tab===t.id} onClick={()=>setTab(t.id)}>{t.t}</Pill>
                ))}
              </nav>
            </header>

            {tab==='workout' && (
              <section className="mt-4">
                <div className="flex gap-2 overflow-x-auto pb-2">
                  {LIB.map(m=> (<Pill key={m.id} active={activeMuscle===m.id} onClick={()=>setActiveMuscle(m.id)}>{lang==='ar'? m.ar: m.en}</Pill>))}
                </div>
                <div className="mt-3"><input className="w-full px-3 py-2 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" placeholder={str('search')} value={query} onChange={e=>setQuery(e.target.value)} /></div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                  {filtered.map(ex=> (
                    <div key={ex.id} className="rounded-xl border bg-white/80 dark:bg-zinc-900 border-zinc-200 dark:border-zinc-800 p-3">
                      <div className="font-medium"><span className="block">{ex.en}</span><span className="block opacity-70">{ex.ar}</span></div>
                      <div className="mt-2 text-xs opacity-70">{str('type')}: {str(ex.type)}</div>
                      <div className="mt-2"><button onClick={()=>addExercise(ex)} className="w-full sm:w-auto px-3 py-2 rounded-md text-sm bg-indigo-600 hover:bg-indigo-700 text-white">{str('add')}</button></div>
                    </div>
                  ))}
                </div>
                {current.items.length>0 && (
                  <div className="mt-6">
                    <h2 className="text-lg font-semibold mb-2">{str('sets')}</h2>
                    <div className="flex flex-col gap-4">
                      {current.items.map((it,idx)=> (
                        <ExerciseCard key={it.id} it={it} idx={idx} lang={lang} str={str} settings={settings} onChange={(patch)=> updateItem(it.id, patch)} onRemove={()=> removeItem(it.id)} />
                      ))}
                    </div>
                    <div className="mt-6 flex items-center justify-between">
                      <div className="text-sm opacity-80">Volume: <b>{Math.round(totalVolume)}</b></div>
                      <button onClick={finishAndSave} className="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white">{str('finishSave')}</button>
                    </div>
                  </div>
                )}
              </section>
            )}

            {tab==='history' && (
              <section className="mt-4">
                {history.length===0 && (<div className="opacity-70">{str('noSessions')}</div>)}
                <div className="flex flex-col gap-3">
                  {history.map(s=> (
                    <div key={s.id} className="rounded-xl border bg-white/80 dark:bg-zinc-900 border-zinc-200 dark:border-zinc-800 p-3">
                      <div className="flex items-center justify-between gap-2">
                        <div>
                          <div className="font-semibold">{str('session')} · {new Date(s.startedAt).toLocaleString()}</div>
                          <div className="text-sm opacity-80">Volume: {Math.round(s.volume)}</div>
                        </div>
                        <div className="flex gap-2">
                          <IconButton onClick={()=> alert(JSON.stringify(s,null,2))}>{str('view')}</IconButton>
                          <IconButton onClick={()=> useAsTemplate(s)}>{str('useTemplate')}</IconButton>
                          <IconButton onClick={()=> deleteSession(s.id)}>{str('delete')}</IconButton>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </section>
            )}

            {tab==='profile' && (
              <section className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Field label={str('bodyWeight')}><input className="px-3 py-2 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" type="number" step="0.1" value={profile.bodyWeight} onChange={e=> setProfile(p=> ({...p, bodyWeight: e.target.value}))} /></Field>
                <Field label={str('height')}><input className="px-3 py-2 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" type="number" step="0.1" value={profile.height} onChange={e=> setProfile(p=> ({...p, height: e.target.value}))} /></Field>
                <Field label={str('experience')}>
                  <select className="px-3 py-2 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" value={profile.exp} onChange={e=> setProfile(p=> ({...p, exp: e.target.value}))}>
                    <option value="beginner">{str('beginner')}</option>
                    <option value="intermediate">{str('intermediate')}</option>
                    <option value="advanced">{str('advanced')}</option>
                  </select>
                </Field>
                <Field label={str('stackStep')}><input className="px-3 py-2 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" type="number" step="0.5" value={settings.stackStep} onChange={e=> setSettings(s=> ({...s, stackStep: Number(e.target.value)}))} /></Field>
                <Field label={str('barbellStep')}><input className="px-3 py-2 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" type="number" step="0.5" value={settings.barStep} onChange={e=> setSettings(s=> ({...s, barStep: Number(e.target.value)}))} /></Field>
                <div className="sm:col-span-2"><button onClick={()=> alert(lang==='ar'? 'تم الحفظ':'Saved')} className="px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white">{str('saveProfile')}</button></div>
              </section>
            )}

            {tab==='backup' && (
              <section className="mt-4">
                <div className="flex flex-wrap gap-2"><button onClick={doExport} className="px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white">{str('exportJson')}</button></div>
                <div className="mt-4">
                  <Field label={str('importJson')}><textarea className="w-full min-h-[180px] px-3 py-2 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700" placeholder={str('dataHere')} value={importText} onChange={e=> setImportText(e.target.value)} /></Field>
                  <div className="mt-2 flex gap-2"><button onClick={doImport} className="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white">{str('apply')}</button><button onClick={()=> setImportText('')} className="px-4 py-2 rounded-md border bg-white/80 dark:bg-zinc-900 border-zinc-300 dark:border-zinc-700">{str('cancel')}</button></div>
                </div>
              </section>
            )}

            <div className="h-14" />
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
